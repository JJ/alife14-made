\documentclass[letterpaper]{article}
\usepackage{natbib,alifeconf}
\usepackage{url} 
\usepackage{subfigure}
\usepackage[english]{babel}


\title{Evolving stories}
\author{Rub\'en Garc\'ia$^{1}$, Pablo Garc\'ia$^{2}$ \and JJ Merelo$^2$ \\
\mbox{}\\
$^1$Fundaci\'on I+D del Software Libre, Granada \\
$^2$Grupo GeNeura, Depto. de Arquitectura y Tecnología de Computadores, Universidad de Granada \\
raiben@gmail.com}


\begin{document}
\maketitle

\begin{abstract}

%The creation of fictional stories is a very complex task that usually
%implies a creative process where the author has to combine characters,
%conflicts and plots to create an engaging narrative. This work
%presents a simulated environment with hundreds of characters that
%allows the study of coherent and interesting literary archetypes (or
%behaviours), plots and sub-plots. We will use this environment to
%perform a study about the number of profiles (parameters that define
%the personality of a character) needed to create two emergent scenes
%of archetypes: ``natality control'' and ``revenge''. A Genetic Algorithm (GA)
%will be used to find the fittest number of profiles and parameter
%configuration that enables the existence of the desired archetypes
%(played by the characters without their explicit knowledge). The
%results show that parametrizing this complex system is possible and
%that these kind of archetypes can emerge in the given environment.

% NUEVO ABSTRACT
% AtenciÃ³n, he cambiado cosas. -RH
Stories are not only painfully weaved by crafty writers in the
solitude of their studios; they also have to be produced massively for
non-player characters in the video game industry or tailored to
particular tastes in personalized stories. However, the creation of
fictional stories is a very complex task that usually implies a
creative process where the author has to combine characters, 
conflicts and backstories to create an engaging narrative.
This work presents a general methodology to generate cohesive and coherent
backstories where desired archetypes (universally accepted literary symbols) can emerge in complex stochastic systems.
This methodology supports the modeling and parameterization of the agents, the environment where they will live and the desired literary setting. The use of a Genetic Algorithm (GA) is proposed to establish the parameter configuration that will lead to backstories that best fit the setting. Information extracted from a simulation can then be used to create the literary work.
To demonstrate the adequacy of the methodology, we perform an implementation using a specific multi-agent system and evaluate the results.
%FERGU: TODO en el abstract (de los comentarios de Antonio)
% Definir literary setting
% Mencionamos simulaciÃ³n, pero no la explicamos antes
\end{abstract}

%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   INTRODUCTION   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\section{Introduction}
\label{sec:intro}

In video games, Non-Player Characters (NPCs)  are a type of characters
that live in the game world to provide a more inmersive
experience and, in some cases, present a challenge to the human player. Modern  Role Playing Games (RPGs), such as The
Witcher\texttrademark~or Skyrim\texttrademark~ include hundreds of NPCs. The effort to create a good interactive fiction script is directly proportional to the number of these characters. Thus, this kind of agents usually present limited behaviors, such as wandering in the villages, selling groceries or guarding the cities. Moreover, they usually offer scripted conversations (for example, to buy and sell objects to the player), or scripted behaviors, in which they interact with the player only if he/she conducts an specific action: for example, if the player steals something then a city guard would attack him. These characters are frequently programmed to interact with the human player, following a guided sequence of activities just with this purpose, so normally they do not interact among themselves. In a world with such a number of characters, their collective interactions could improve the gaming experience, leading to a richer and more inmersive world. For example, hungry inhabitants could become thieves, guards could pursuit the thieves, villagers could fell in love with others, or different war alliances could emerge.


%FERGU: HABLAR DE LA METODOLOGIA COMO UNA NARRACION Y DESCRIBIR LITERARY SETTING!
These facts have motivated us to develop a methodology to model the language, agents and literary setting to generate backstories. In this methodology, a set of probabilities and 
states are associated to agents' actions, and these probabilities are
optimized by means of a Genetic Algorithm to match with a
specific literary archetype, defined by the fiction creator. The {\em
archetypes} are behaviors and patterns universally accepted and
present in the collective imaginary
 \cite{ArchetypesGarry05}. They allow to empathize  % mal escrito, y Ã FERGU: arreglado. SÃÂ­, existe.Â¿existe empathize? - JJ
with the characters and aid to immerse the spectator in the story
(for example, the well-known {\em hero} archetype).


%To establish how an agent correspond with a specific archetype 
%we use the concept {\em profile}. A profile are the set of characteristics
% or patterns that... The number of this profiles in an story could be variable, so it is necessary to..

%These probabilities are
%optimized by means of an Evolutionary Algorithm (EA) to match with a
%specific literary archetype, defined by the fiction creator.

%Finally, the results of the execution is used to create the...

% Explica como caracterizas el arquetipo a partir de una serie de
% eventos en su historia personal y su relaciÃÂ³n con el resto de los
% personajes - JJ

% FERGU: aÃÂ±adido arriba, Ruben, completalo que tu lo dominas mÃÂ¡s






To validate our methodology we also present a multi-agent system called
MADE (Massive Artificial Drama Engine) to model a self-organized
virtual world where every element influences each other, following
cause-effect behaviors in a coherent manner. This system must be
a suitable environment for the plot of a specific literary work, also being
interesting for the player/spectator. %FERGU: dice antonio que pongamos aquÃ­ un par de tÃ©cnicas en las que se basa MADE

The aim of this work is to answer the following questions:


 Is it possible to model a virtual environment inhabited by hundred of characters with interesting auto-generated behaviors based on literary archetypes?
 Could the personality of the agents be parametrized to obtain different behaviors?
 %\item How many profiles (groups of parameters that define a personality) are necessary to generate emergent quality sub-plots? %FERGU: quitada
 Could a Genetic Algorithm be used to find the fittest parameter values that allow the creation of quality sub-plots?
% \item Could the obtained results of our methodology be used to create a literary work? %FERGU: pregunta aÃÂÃÂ±adida que hay que contestar
Could this methodology be exported to be used in a bigger task such as creating a literary piece or work?
\
%FERGU: Antonio propone esta pregunta en lugar de la Ãºltima: Could this methodology be exported to be used in a bigger task such as creating a literary piece or work?
%RH: Cambiado

%Estas preguntas son las que tienes que contestar en las
%conclusiones. Si no, el trabajo ha fallado - JJ2013 FERGU:TODO mirad que estÃ©n contestadas al final

In this paper we show that GAs, together with a proper design of
literary patterns, can be used to find the parameters that promote the
generation of drama plots and sub-plots in a multi agent based
environment.\\

% pero ÃÂ¿quÃÂ© te da MADE? ÃÂ¿QuÃÂ© extraes de ÃÂ©l? ÃÂ¿La historia de los
% personajes? ÃÂ¿El perfil de los mismos? TenÃÂ©is que dejar muy claro
% cuÃÂ¡l es el PRODUCTO del algoritmo, porque si lo que tratas de hacer
% es un mundo en que los personajes sigan unos porcentajes
% determinados y eso es lo que obtienes, no tiene ninguna gracia - JJ

The rest of the work is structured as follows: after the state of the art, the proposed methodology is presented in Section \ref{sec:methodology}. Then, some experiments, showing possible applications of this methodology (including the GA application) are presented (Section \ref{sec:applying}). Finally, conclusions and future work are discussed.

%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   STATE OF THE ART  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%

% -----------------------------------------------------------------------------
% SEC SOA

\section{State of the art}
\label{sec:soa}

% (JJ2013): Por cierto, acabo de ver esto: \cite{StoryTecGobel2008}.
%TODO

Auto-generated interactive fiction research is mainly focused in
methods to create the process of a story generation
\cite{nairat2011character}. Story generation, or storytelling, can be divided in two areas: interactive and non-interactive. In the first one, and
according to \cite{ReviewArinbjarnar09}, an {\em interactive drama} is
defined in a virtual world where the user is free to interact with
the NPCs and objects in an interesting experience (from the dramatic point of view), which should be different in each execution, and adapted to the user's interaction.

The generation of interactive dramas can be based on a script
structure \cite{ArchitectureYoung04} and dramatic structures, where an inciting accident provides the motive of the drama, is followed by an increase of complications to a climax point and, finally, descending to a closure. Two examples of this approach are The Oz Project~\cite{ozproject}, that requires generated narratives to follow a dramatic arc, and Fa\c{c}ade \cite{facade}, that uses a structure
which they call neo-Aristotelian, an adaptation of the Aristotelian
structure to interactivity.
%TODO referencias

On the other hand, in {\em non-interactive plot generation systems} the user
does not take control as the protagonist but can participate in the final result. For example, in the system
presented by Pizzi et al. \cite{pizzi2007interactive} the user can change the emotions of the other characters but as an spectator not as an actor.

Those techniques and systems presented at the moment are focused in generating stories (interactive and non-interactive), but the present methodology, as opposed to this concept, is focused in \textit{generating a setting}
because its aim is the massive background generation
for secondary characters, in order to provide a context for the writer and the
player to perceive a virtual world as coherent, detailed and
enriched.
%In this respect, story generation systems such as Tale-Spin \cite{talespin}, Universe \cite{universe}, Minstrel \cite{minstrel} or Virtual Story Teller\cite{virtualstoryteller} are more aligned with our goal, since they are not focused in the interaction with the user.

The narrative is addressed by our methodology as the final step, giving freedom to creators. This issue has been studied in the systems presented in
the survey by Arinbjarnar et al. in \cite{ReviewArinbjarnar09}. 

Previous works define the plot as as something that emerges from the behavior of the agents that follow a set of rules. In the proposed methodology, the agents' behaviour is produced by their personality and the environment. That is, the agents do not follow a plot, but they generate the plot itself.

Furthermore,  previous works generate plots in worlds with a limited number of characters. This restriction does not exist in our methodology, where the number of characters to create is unlimited: They are created massively and their goal is to relate in a complex system and generate backgrounds that fit the setting of a plot, not the plot itself.

The present methodology follows the ideas of the work by Epstein and Axtell
\cite{epstein1996growing}, 
the first widely known multi-agent generative social model. As a step of the methodology, a self-organizing system if defined following the methodology introduced by Gershenson
\cite{gershenson2005general}: a virtual world, agents who are born, grow, 
interact, reproduce and dead; resources (food), mediators, and
relations of rivalry (friction) and cooperation (synergy). In other step of our methodology, the actions of the agents are parametrized according the work of Nairat
\cite{nairat2011character}, based in the use of GAs in order to
obtain a plot (solution) where two characters interact in a creative way.

The proposed methodology is innovative since the goal has not been addressed before. Previous researches are focused on the plot, the interaction, and the narrative, but our proposal is focused in backgrounds (not in plot), where different archetypes emerge involving a starting point for future plots and subplots.

%Antonio: Entiendo que esto es nuevo, no lo que hizo ya el tal Nairat,Â¿no? Queda un poco lioso y puede parecer que esto ya lo hizo ese menda, cuando yo creo que tÃº quieres decir que os basÃ¡steis en su trabajo para hacer esto, que Ã©l no hizo. ;)

According to the taxonomy described by Togelius et al. \cite{Togelius2011}, the present methodology can be classified as a \textit{procedural content generator} (\textit{PGC})
mainly related to \textit{optional content}, with \textit{stochastic generation}
and modeled as a \textit{generate-and-test} algorithm (search based), that
performs the optimizations of the process during the game development (\textit{offline}).

%ANTONIO: Echo de menos una mayor defensa de lo bueno que es MADE, que es algo nunca hecho, que avanza mucho el estado el arte (porque no hay mucho, aparentemenet), que abre nuevas lÃ­neas de investigaciÃ³n, nu se, dadle bombo. ;D



%The current experiment allows the definition of behaviour patterns (or
%archetypes, and using a weighted fitness function to measure
%the presence of the desired archetypes.

%TODO: presentar la metodologÃ­a del pÃ¡rrafo siguiente

%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   METHODOLOGY   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%

\section{Methodology}
\label{sec:methodology}

The mood, or the atmosphere, of the literary setting is one element in the narrative structure of a piece of literature. It is established in order to affect the reader emotionally and psychologically and provide a feeling for the narrative.
%TODO aÃ±adir referencia a The Book of Literary Terms, University Press of New England, 1999


The present methodology defines different steps that will lead the user from the initial question ``\textit{How could I obtain secondary characters for my setting, with coherent backstories consistent with its mood?}'' to a system that can automatically generate a setting massively populated with characters and backstories, where different desired behaviors or archetypes emerge from their interactions.

In our approach, the mood of the setting will be modeled as a group of abstract archetypes and different conditions over them. These archetypes, conceptually modeled, would be designed and instantiated as regular expressions over a language used to describe the backstories along with the social relationships between them. Those instantiations will be used by the GA to obtain the fitness of each solution. The process is iterative and presented as a waterfall model, where each step influences the following one.

The methodology includes the following steps, as shown in Figure~\ref{fig:methodology}: Modeling - the language, the literary setting, the agent -, Definition of the GA characteristics, Instantiation, Execution and Interpretation, which will be exposed in the following subsections.


\begin{figure}[htb]
\centering
   \includegraphics[width=12pc] {img/methodology.pdf}
\caption{The proposed methodology for designing literary backstories}
\label{fig:methodology}
\end{figure}


\subsection{Modeling}

The Modeling step affects different elements that make up a system where different agents generate words, lately interpreted as backstories, whose symbols belong to a language that also defines the desired archetypes.


\subsubsection{Modeling of the language}

Each agent has to be modeled as a Finite State Machine (FSM) whose transitions generate symbols in a language based on the following one, expressed in Backus-Naur Formalism (BNF):

\begin{verbatim}
<backstory> ::= <action_line> [<backstory>]
<action_line> := <date> <action>;
<action> = <action_id> [<direct_object>]
           [to <indirect_object>]
\end{verbatim}

Starting from this partial grammar, the user has to define the expressions:
\begin{itemize}
\item \textbf{<date>}: Should be expressed in a way that is meaningful to the type of background that we are looking for.For example, if we are talking about persons, it could be the age of the agent expressed in days.

\item \textbf{<action\_id>}: Different actions can be taken into account, and will depend on the kind of archetypes we will look for. For example, if we are trying to find archetypes about love like the classical Romeo and Juliet one, where two characters are in love but belongs to families in war and finally ends up with their death, we could include actions and relations like ``loves'', ``hates'', ``is son of'', ``is daughter of'', ``is parent of'', ``die'', etc.

Obviously, the smaller the group of possible actions is, the easier would be to find out the archetypes. In order to minimize the number of available actions and maximize the number of archetypes they allow we propose generic actions instead of specific ones.

\item \textbf{<direct\_object>}: The possible values of the direct objects depend on the nature of the actions.

\item \textbf{<indirect\_object>}: Should define the unique id of an agent or a group of agents.

\end{itemize}

The backstory generated by each agent using the language modeled this way will be automatic and human readable. Eventually, the backstories will evoke archetypes and behaviours. As we will see in the next sections, we will try to promote the emergence of specific archetypes in order to retrieve the best backstories for our setting.



\subsubsection{Agent modeling}


In a top-down approach (the opposite to the one proposed in the current methodology), if the creative needs a second character or an extra for a story, he or she creates it out of the blue, with the background that better fits with his/her needs. This approach, valid for a small amount of characters and poor requisites of coherence between them, becomes more and more complex when we add more characters to the environment, because each addition implies new relations in their social network.
%TODO Alguna referencia a la complejidad exponencial de las redes sociales cuando se aÃ±ade un indivÃ­duo


Otherwise, the bottom-up approach promotes the agent as one of the pillars of the system because it offers the coherence of the backstory regarding to the timeline (for example, an agent cannot die before he or she is born). Some actions need to be sequential and to the relations (many actions involve two different agents). An agent is just a simple tool to generate a background, a character. In an environment where many characters can ``live'', make decisions taking into account the other characters and affecting them, the generated background becomes complex, many links have been created and no creative process has taken part on it (the creative process is present in the definition and modeling of the agent itself).

Given this premise, a multi-agent system seems promising for generating this kind of complex relations and backstories.
%In this section we propose an agent's architecture and explain its characteristics.

%\textbf{Agent as a finite state machine}\\


An agent can be seen as a Finite State Machine (FSM), so the multi-agent system relies in the sequential executions of time portions. Every execution implies a review of the current state and (maybe) one or more actions done, depending on local and external properties.\\

Given a set of states, properties and actions modeled, the logic of the main process should be:

\begin{enumerate}
\item Collect internal and external information.
\item Depending on the state and the information collected, select the possible actions and probabilities to perform them.
\item Use random numbers to decide the action to perform.
\item Generate an action line using the language selected in the previous stage.
\item Select the new state.
\end{enumerate}


The agent should contemplate different states depending on the type of information we are interested in (``alive'', ``dead'', ``pregnant'', etc) and should also have local properties that define the possibility to make certain decisions.

It is important to remark that an agent is a simplification of the character (in the way that it will perform only the actions we are interested in) and that the agent is inspired in conceptual behaviors, so some actions and transitions are mandatory and depend on the personality and internal states.\\

%\textbf{The agents' execution environment}

Agents live in an {\em environment}, understood as the virtual spatio-temporal frame where the agents play their lives. This environment is also responsible for:
\begin{itemize}
\item execute the main process of each agent (corresponding to a portion of time). Each iteration the agents should be chosen randomly or based in classical role-playing games features like ``initiative''.
\item provide a set of functions to interact with other characters and the environment itself.
\end{itemize}


%\textbf{Modeling the parameterization of the agent}

The key in the use of agents to create background for characters relies in the following fact: Some actions are performed statically depending on the inputs and the current state but other (the majority) also depends on agent's local features and probabilities. Even if all the agents share these values, it is difficult to predict the result when the system is so complex. A minimal change in one probability to make one decision can imply completely different scenes.
For this reason, some actions should be statically defined and others have to depend on initialization properties. We define two kind of properties:
%TODO revisar y aÃ±adir referencia a sistemas complejos, seguro que alguien mÃ¡s listo que yo ya ha dicho esto antes que yo


\begin{itemize}
\item \textbf{Base properties}: Those that are intrinsically defined by the nature of the conceptual agent. For example, if we are modeling a simplification of a person, the average life expectancy could take values from 70 to 85 years. An agent that lives 100 years would be unusual, and an agent that lives 200 years should not be possible.
\item \textbf{Searchable properties}: Those used to increment or decrement the base values in the established limits or those that are used directly as probabilities to make decisions.
\end{itemize}

%TODO diagrama del concepto de property base y property configurable

Due to the complexity of the system and the introduction of probabilities, even if all the agents have the same features and probabilities, the sequence of the actions for every agent becomes unpredictable. For example, if we have our agent modeled and we choose random values for the configuration, roughly, the characters' backstories will be ``normal'', showing more or less the stereotyped behaviors (that make the character a group representative rather than an individual), but maybe, some of them show higher level non-modeled behaviors. In the next subsection, we will provide a way to model those high-level behavior in the way that, given a executed environment, a computer is able to find them 
and, in the Execution step, obtain a configuration that promote the apparition of these archetypes in the execution.

\subsubsection{Literary setting modeling}

%TODO tener en cuenta a lo largo del texto que actions tb pueden ser predicates

The setting of a story is defined as the historical moment in time and geographic location in which it takes place, and helps initiate the main backdrop and mood for a story.
Conceptually, the setting of a story is, in this methodology, independent from the agent design, but has to agree with it in the selected language: 
The agent generates actions in a previously defined language with a clear semantic interpretation. On the other hand, the setting is composed by criteria over patterns for this language and the social networks derived from its usage. In other words, the agents create backstories and the settings matches specifics patterns inside these backstories.

For Example, if we have a medieval storytelling setting and we have defined a language where the actions ``love'', ``hate'', ``attack'', ``defend'', ``win'' y ``lose'' are used, we could try to find classic 
%TODO citar de donde he sacado que son clÃ¡sicos
archetypes like the ``villain'' and the ``hero''. A villain could be a character that hate many others, attacks them and win. A hero could be a character who is loved by many people, that eventually defends them and then attacks to the villain. Moreover, if the mood of the story is sentimental, we could be interested in a ``heartbreak and reencounter'' archetype, where two characters are in love, after that they hate each other and finally fall in love again.

In our methodology, an archetype is designed as a function that receives the backstory of an agent, processes it, tries to find patterns and interpret the social network related to the agent, and returns a /true/ value if the agent matches the behavior. 
%TODO dibujo intuitivo: la ambientaciÃ³n te ofrece una funciÃ³n cuya entrada los los agentes
The complexity of the agent is not evaluated, just the result of its execution in this environment. It is important to remark that the agent has to be modeled to play a normal life (stereotype), and that the archetypes work as high level behaviors not directly implemented.

A setting can be seen as a function over the agents that matches an archetype. If the archetypes emerge in the desired way, the setting function would return high values.

In the next section, we will explain the mechanism that will optimize the agent's searchable features to obtain backstories coherent with the mood of the setting.

\subsection{Features of the Genetic Algorithm}

%The Genetic Algorithm needs:
%\begin{itemize}
%\item a chromosome that codes the solution.
%\item a fitness function to evaluate each chromosome.
%\end{itemize} %FERGU: quito esto, que ya se sabe!

The codification of the chromosome consists in mapping the searchable properties to an array of values. %This array of values can be the chromosome.\\

The fitness function of a chromosome is the result of calculating the average of the application of the setting function over \textit{n} executions of the environment with defined base properties (where n is the minimum number that reduces the error and has to be calculated empirically).

It is important to clarify that the term ``individual'' in this work refers to a solution in the GA that models a whole environment, where a number of different ``agents'' are living. So, an ``individual'' in the GA is not equal to an ``agent''.  %FERGU: dejo esto claro para que no se lien los revisores

%TODO dibujo aquÃ­

At this point, we remark the possibility of using different number of {\em profiles}. In this context, a profile is a set of properties assigned to an agent. If two agents have different profiles, their behaviour in the face of the same inputs can be different. In the chromosome, the use of \textit{n} profiles means a chromosome size equal to the number of searchable properties multiplied by \textit{n} 

Intuitively, increasing the number of profiles will lead to richer backgrounds, but \textit{a priori}, since the system is complex, it is very difficult to establish which number of profiles will lead to the fittest solution without empirical tests. In some cases, a small number of profiles can generate many different archetypes and \textit{vice versa}. Moreover, it is important to remark that the bigger the chromosome is, the slowly the solution converge.

%TODO revisar todos los pasos y poner explÄitamente que si no funciona bien hay que volver patrÃ¡s

\subsection{Instantiation and execution}

After the Genetic Algorithm is configured, some properties need to be established in order to fit to the desired setting:
\begin{itemize}
\item Base properties: Including the threshold for the agent's features, and environment parameters (i.e. size of the world, resources, etc).
\item Genetic Algorithm parameters: selection, genetics operators (crossover and mutation and termination condition)
\item Number of profiles
\end{itemize}

Once the parameters for the GA, the environment, the agent and the number of profiles are set, the GA can be executed.
%The best fitness cannot be assured since:
%\begin{itemize}
%\item the environment is uncertain and noisy
%\item the fitness is statistically calculated from stochastic executions
%\end{itemize} FERGU: esto ya se sabe

In some cases, the fitness can be improved by modifying base parameters, the evaluation of the archetypes or the logic of the agent. The process is iterative and a fine tunning is essential to obtain the best fitness.

Once the best solution has been found, the environment can be executed and the backstories generated can be used.

\subsection{Interpretation}

%TODO Convert results to literary language
%TODO Exportar los logs de los agentes, sus caracterÃ­sticas y sus etiquetas
%TODO Intepretar la historia de un agente, junto al arquetipo aporta explicaciones
%TODO Buscar agente que cumpla una condiciÃ³n
%TODO NavegaciÃ³n entre agentes. Apoyo al proceso creativo

Due to the nature of the grammar proposed for the actions, they can be directly converted to natural language. Applying the setting function (used as fitness by the GA) to the executed environment could be useful to tag the backstories with the different archetypes found and their explanations. As an example, if our setting is the ``far west'' and we need non-player characters to populate a saloon, we may want to find a ``Billy the kid'' archetype and three ``player'' archetypes. If they are met by the main character he/she may discover their backstories, that would be coherent with the world they live in and the mood of the story.


% -----------------------------------------------------------------------------
% SEC APPLY


\section{Applying the methodology}
\label{sec:applying}

To validate our methodology we apply its steps using a specific scenario and environment. In this scenario we want to model the next story: %FERGU: IMPORTANTE!!! HE PUESTO STORY, LE PONEMOS OTRA COSA? HAY QUE CUADRAR TODOS LOS CONCEPTOS (VER LISTA ARRIBA)
 - ``A number of rats live, eat, reproduce, compete for food and death within the walls of the Invisible University of Ankh-Morpork\footnote{This is our tribute to writer Terry Pratchett, whose books have inspired us to create these agents.}. As the University professors, these rats are very vindictive and territorial.''

\subsection{Agents in the MADE environment}

The first step is to model the agents and their environment. In this work we propose the MADE (Massive Artificial Drama Engine for non-player characters) environment, a virtual place where different agents play their artificial lives. Its functions are:

\begin{itemize}
\item \textbf{Create an initial set of agents:} MADE environment
  initializes a set of just born orphan agents, each of them with a profile
  sequentially assigned, that must compete or collaborate in order to survive.
\item \textbf{Place agents in the map:} the environment is a squared map, formed by cells that can be occupied by one (and only one) agent. The environment allows the agents to discover and interact with other agents in the neighborhood.
\item \textbf{Start and control the time:} after the creation of the initial set of agents, the MADE environment starts the timer, day by day until a maximum date is reached.
\item \textbf{Execute each agent during a time unit (a day):} In each iteration the list of agents is randomly reordered, and after that following the new order, each agent perform an iteration of its life-cycle. Then the dead agents are removed from the grid.
\item \textbf{Perform as an external agent that changes the environment:} In each iteration in the MADE environment, food rations are placed in random cells. An agent only can eat if it is over a cell with a ration, so agents could move any others forcibly.
\item \textbf{Offer services to the agents:} MADE environment allows the agents to check which neighbor cells have food, are occupied, who agents are in a near position or which positions can be occupied.
\item \textbf{Decide the agents' profile:} MADE allows the existence of different agent profiles, as previously said. A {\em profile} is a set of characteristics which governs the agent's behavior.
\end{itemize}

The MADE environment can be configured by using the following parameters (and its values by default): Number of agents initially placed (15), map square grid dimension (10), number of rations randomly placed in the grid each day (10) and duration in virtual days of the  execution of the environment (1000). These parameters can affect directly to the behavior of the agents.

% (JJ2013): Usas un estilo demasiado conciso. Di quÃÂÃÂ¯ÃÂÃÂ¿ÃÂÃÂ½ hace cada uno de esos
% parÃÂÃÂ¯ÃÂÃÂ¿ÃÂÃÂ½metros, cÃÂÃÂ¯ÃÂÃÂ¿ÃÂÃÂ½mo se meten (fichero de configuraciÃÂÃÂ¯ÃÂÃÂ¿ÃÂÃÂ½n o como sea), por
% quÃÂÃÂ¯ÃÂÃÂ¿ÃÂÃÂ½ se eligen esos y no otros, y los valores por defecto que has
% usado.

% (RubÃÂÃÂÃÂÃÂ©n): por simplificar y reducir tamaÃÂÃÂÃÂÃÂ±o, pongo los valores por omisiÃÂÃÂÃÂÃÂ³n

A MADE Agent lives in a MADE Environment, occupies a cell in the grid, moves around looking for food or mates and interacts with other agents.\\

%En un trabajo no se describe lo que se ha hecho, sino una
%metodologÃÂÃÂ­a. DeberÃÂÃÂ­as justificar estos estados y las acciones. ÃÂÃÂ¿Se
%pueden poner las que quieras? - JJ2013
The design of a MADE Agent has some restrictions:
\begin{itemize}
\item An array of parameters (probabilities represented as real numbers between 0 and 1) should be provided in its initialization. These parameters should be used by the agent in its day-by-day decisions.
\item Every action is subject to be logged for later analysis.
\item As a result of some iterations of the agent's day-based life-cycle, the agent should present the behavior of a \textit{living thing}, that is born, eats, grows, reacts, reproduces and dies.  
\end{itemize}

A very simple agent has been designed for this study: a virtual
rat, that models:
\begin{itemize}
\item Four states (be alive, be hungry, look for
mate and be pregnant) that represent internal situations that will lead the
agent to perform the actions described in the item bellow. % No se
                                % usan nÃÂºmeros Cambiar abajo - JJ FERGU: OK
\item Seven actions (move, eat, attack, defend, escape,
find mate and have offspring) that lead to a basic instinctive animal
behaviour, very useful for this work since it can be the canvas of 
complex \textit{humanized} behaviour patterns.
\item Parameters that define the characteristics and probabilities to
perform actions depending on the state.
\end{itemize}
It is important to remark that no ``feelings'' and no ``memory''
have been modeled in the MADE agent for this study. This is
illustrated in Figure~\ref{fig:madeAgent}.

\begin{figure}
\begin{center}
\includegraphics[scale=0.35]{img/MadeAgent.pdf}
\caption{Actions and states modeled in the MADE Agent.}
\label{fig:madeAgent}
\end{center}
\end{figure}




%The life cycle of a MADE Agent illustrated in
%Figure~\ref{fig:lifecycle} represents on day in its life. 
Every
decision made by the agent is based on its state and its
characteristics (probabilities to perform different actions). % Los
                                % agentes son un FSM entonces, ÃÂÃÂ¿no?
                                % Cita los papers en los que hablamos
                                % de FSM para Mario o Unreal, por ejemplo.
                                % ÃÂÃÂ¿Esto es fijo? - JJ2013



% (RubÃÂÃÂÃÂÃÂ©n): TODO ÃÂÃÂÃÂÃÂ¿citar todas las caracterÃÂÃÂÃÂÃÂ­sticas de un agente made?
% SÃÂÃÂÃÂÃÂ³lo si hay hueco, creo
% No se ve nada y no aporta mucho. No uses notaciÃÂÃÂ¯ÃÂÃÂ¿ÃÂÃÂ½n del programa, sino
% del algoritmo. Y mejor que lo contaras como un algoritmo usando el
% entorno algorithmic que este grÃÂÃÂ¯ÃÂÃÂ¿ÃÂÃÂ½fico. - JJ2013

% (RubÃÂÃÂÃÂÃÂ©n): TODO No se cÃÂÃÂÃÂÃÂ³mo mejorarlo...

% CÃÂÃÂ¡mbialo por un algoritmo. Ocupa demasiado espacio y no se ve nada.
% O bien dibÃÂÃÂºjalo como un autÃÂÃÂ³mata de estados finitos en vez de un
% diagrama de flujo. Un redondÃÂÃÂ³n por estado y flechas de transiciÃÂÃÂ³n -
% AdemÃÂÃÂ¡s, me da la impresiÃÂÃÂ³n de que estÃÂÃÂ¡s mezclando estados de un
% bicho (pregnancy) con los de otro (a partir del nacimiento). Si es
% asÃÂÃÂ­, mÃÂÃÂ¡s que pregnancy deberÃÂÃÂ­as llamarlo "embryo" (y, sinceramente,
% no sÃÂÃÂ© si merece la pena mencionarlo aquÃÂÃÂ­ y quÃÂÃÂ© interÃÂÃÂ©s puede tener)
% JJ2013


The MADE Agent is created using twelve parameters, that define its
base features and probabilities to make the decisions presented in the
state diagram in Figure \ref{fig:fsm}. The execution of an
agent is dynamic, and depends on the internal probabilities and states
but also on the neighborhood, and the map configuration. Even so, we
can say that these initial parameters define in some way the possible
situations where the agent could be involved.

\begin{figure}
\begin{center}
\includegraphics[scale=0.35]{img/fsm.pdf}
\caption{MADE Agent's finite state machine}
\label{fig:fsm}
\end{center}
\end{figure}



The source code of the MADE environment and the algorithms used in this experiment are publicly available in \url{http://ANONYMOUS} under a LGPL license.

\subsection{Definition of the literary setting}

As previously said, agents are independent of the desired literary settings. To validate our approach two different literary settings are going to be tested.

The first one, ``territorial war'' scene, aggregates different sample archetypes where many factors must be taken into account.  It tries to find the number of profiles and values that are optimal to:
\begin{itemize}
\item Ensure that, after 1000 virtual days, the alive population will be the 60\% of the total population. This archetype, called \textit{survival population}, affects all the population, so it is a \textit{global archetype}.
\item Emerge the \textit{downtrodden} archetype in the 22\% of the
  population. An agent will be considered as a \textit{downtrodden} or
  \textit{defender} if it has been attacked at least two times and has
  defended the position.
\item Emerge the \textit{warrior} archetype in the 22\% of the population. An agent will be considered as a \textit{warrior} if it has satisfactory attacked at least five times.
\item Emerge the \textit{helpless} archetype in the 22\% of the population. An agent will be considered as a \textit{helpless}  if it has been attacked at least ten times and has not defended the position.
\item Emerge the \textit{bad warrior} archetype the in 22\% of the population. An agent will be considered as a \textit{bad warrior}  if it has unsatisfactory attacked at least ten times.
\end{itemize}
We have used the presented values to define this scene because, in our opinion, they model an interesting literary scene.


The second literary scene is called ``revenge'' and its goal is to model an individual complex memory
based behaviour between two characters. This scene is performed to make more complex memory based behavior emerging between two characters:  It tries to find the number of profiles and values which are optimal to make \textit{revenge} archetype emerge in as many agents as possible after 1000 days.  An agent (a) will be considered as a \textit{avenger} if it has been attacked by other agent (b) and after that, in a moment in its life, it has satisfactory attacked the agent b, in \textit{revenge}. The value of the days is set to 1000 because is a duration long enough to make the archetype emerge. 

\subsection{Definition of  the genetic algorithm}


To model the ``territorial war'' setting we have defined the fitness function as follows: if the exact percentage of agents are tagged with one archetype defined, 1 point is added to the fitness. The maximum is therefore, 5 points. However, all the fitnesses use a normal distribution over the percentage of appearance. For example, with the archetype ``survival population'', the maximum value (1) is obtained when the 60\% percent of the population is alive, and the normal distribution begins in the 30\% and ends in the 90\%. For the rest of the archetypes, 1 point is added if the 22'5\% of the population is tagged with each one of the archetypes, and each normal distribution begins in the 8\% and ends in the 30\%.

For the second literary setting (``revenge''), every agent whose log matches the archetype adds one point to the fitness. Therefore, the goal is to recreate an environment where several ``avenger'' agents exist.

Thanks to the agents' logs, we can know every event (internal and
external) of their lives, and evaluate their interest or
adequacy to a specific literary setting.
                                % interest in
                                % what? Quieres decir si son
                                % interesantes? - JJ2013
In this work, we have implemented a method based in regular expressions with backreferences. The proposed technique puts annotations in every agent whose log matches a complex regular expression able to find emerging high level behaviours, not implemented in the life-cycle.

In this proposal, the parameters used to define an agent, mentioned in Section~\ref{sec:methodology}, are mapped into a chromosome, and a Genetic Algorithm is used to evolve the solution. The fitness function is expressed in terms of:

\begin{itemize}
\item \textbf{Regular expressions applied to the log of each agent in the environment:} An agent is tagged when a regular expression matches its log.
\item \textbf{A numeric function over the number of tagged agents for each archetype:} the fitness of the solution is incremented with the returning value.
\end{itemize}

% Our assumption is that
% some archetypes could emerge using one profile but others may need
% more (those that require two clearly differentiated roles).

In this case,
 we do not exactly know how many roles are necessary to create a world of ``warrior'' or ``vindictive''
  rats, so different number of profiles (from one to five) will be considered.


%Different number of profiles (from one to five) have been used to assign
% ÃÂÃÂ¿QuÃÂÃÂ© son los perfiles? No lo has definido en ningÃÂÃÂºn sitio. DeberÃÂÃÂ­as
% ponerlo tambiÃÂÃÂ©n en el abstract si es tan importante - JJ2013
% Sigue sin estar claro, ni quÃÂ© relaciÃÂ³n hay entre perfiles,
% arquetipos, nÃÂºmero d elos mismos ... igual un grÃÂ¡fico ayudarÃÂ­a. O un
% ejemplo - JJ
%different parameters to different agents. 

If only one profile is used
in a run, all the agents are created with the same parameters, evolved
by the Genetic Algorithm. If more profiles are used, they are assigned
to the agents in order of appearance in a loop. Our assumption is that
some archetypes could emerge using one profile and other will need
more (those that require two clearly differentiated roles). It is
important to remark that the number of alleles of the chromosome are
multiplied by the number of profiles, so the convergence of the
solution will be be affected by the number of profiles used. 

% Profile viene a ser las caracterÃÂ­sticas o patrones que hacen que
% sepamos o podamos asociar una historia a un arquetipo, ÃÂ¿correcto? No
% has hecho suficiente ÃÂ©nfasis en esto y lo de los nÃÂºmeros queda un
% poco en el aire. DeberÃÂ­as introducirlo preguntÃÂ¡ndote eso: ÃÂ¿cÃÂ³mo
% sabemos si un individuo corresponde a un arquetipo? AsÃÂ­ introduces
% los perfiles, y luego hablas de que los perfiles se deben de hacer a
% mano, cuantos hacen falta... - JJ FERGU: puesto en la intro



\subsection{Execution and results}

For the experiments performed in this work, we have used the parameters shown in Table~\ref{fig:ga_parameters}. These values have been chosen empirically after several test runs.

\begin{table}
\begin{center}
\caption{Parametrization of the Genetic Algorithm}
\label{fig:ga_parameters}
\begin{tabular}{cc}%{p{3cm}p{7cm}}
\hline\noalign{\smallskip}
\noalign{\smallskip}
Parameter & Value \\
\hline
\noalign{\smallskip}
Codification & 12 alleles per profile\\
Fitness function & Average of 10 executions.\\
Natural selector & Original Rate: 0.9 \\
Crossover operator & Rate: 35\% \\
Mutation operator & Desired Rate: 12 \\
Stop condition & 100 executions\\
Generations & 30\\
Population size & 30 \\
\hline
\end{tabular}


\end{center}
\end{table}

%\subsection{Analysis of the results}





Table~\ref{fig:exp1_30ex} shows the average of the best fitness and the average population fitness at the end of 30 executions for each configuration: number of profiles from 1 (P1) to 5 (P5) in the experiment 1 (``natality control'').
The evolution of the best fitness for each configuration is shown in Figure~\ref{fig:evo1}. We have performed a Kruskal-Wallis test for the best individuals fitness, obtaining differences among all the number of profiles (p-value $<<$0.05). As we suspected, it is clear that using one profile is not enough to emerge the desired archetype. However, the pairwise comparison using Wilcoxon does not find significant differences using more than 2 profiles. This can be explained because an agent could share more than one archetype at the same time.  A promising number of profiles could be 4, because their only lower outlier is not as distributed as the others. As can be seen in Figure \ref{fig:evo2} the evolution of the best fitness increases with all possible number of profiles, existing therefore an increase of the performance of the system.

\begin{table}
\begin{center}
\caption{Results for 30 executions of each configuration using 1 to 5 profiles in the experiment 1}
\label{fig:exp1_30ex}

\begin{tabular}{lllll}
\hline\noalign{\smallskip}
\parbox[t]{1.5cm}{Number of\\ profiles}
& \parbox[t]{2cm}{Best fitness\\ (average) *}
& \parbox[t]{2cm}{Average\\ fitness **} \\
\noalign{\smallskip}
\hline
\noalign{\smallskip}
1 & 0,765 $\pm$ 0,037 & 0,761 $\pm$ 0,038 \\
2 & 1,063 $\pm$ 0,115 & 1,059 $\pm$ 0,114 \\
3 & 1,093 $\pm$ 0,063 & 1,091 $\pm$ 0,062 \\
4 & 1,084 $\pm$ 0,048 & 1,082 $\pm$ 0,048 \\
5 & 1,045 $\pm$ 0,110 & 1,041 $\pm$ 0,108 \\
\hline
\end{tabular}
\\
\** Average of the best fitness at the end of each execution\\
% Es decir, coges el mejor fitness de cada ejecucion (tendras 30 por cada
% numero de perfiles) y sacas la media
\*** Average population fitness  at the end of each execution \\
\end{center}
\end{table}



The results of the second experiment are shown in
Table~\ref{fig:exp2_30ex}. It shows the average of the best fitness
and the average population fitness at the end of 30 executions for
each configurations. Boxplots of the best fitness obtained are shown
in Figure \ref{fig:subfig2}. In this case, Kruskal-Wallis and Wilcoxon
pairwise comparison shows significant differences among all
configuration (p-value $<<$ 0.05) except between P2 and P3
(p-value=0.3). Therefore, we can conclude that in this kind of global
archetype only a profile must be used for obtaining the best
results. This makes sense, because we are looking for one type of
local archetypes ({\em avenger}), so adding extra profiles leads to
different behaviours of the agents. 
% si vas a analizar los resultados, deberÃÂ­as mostrar tambieÃÂ cÃÂ³mo
% cambia el mejor fitness y el intermedio, para que se pueda ver si el
% AG se hace bien o mal o regular. - JJ


\begin{table}
\begin{center}
\caption{Results for 30 executions of each configuration using 1 to 5 profiles in the experiment 2}
\label{fig:exp2_30ex}
\begin{tabular}{lllll}
\hline\noalign{\smallskip}
\parbox[t]{1.5cm}{Number of\\ profiles}
& \parbox[t]{2cm}{Best fitness\\(average) *}
& \parbox[t]{2cm}{Average\\fitness **} \\
\noalign{\smallskip}
\hline
\noalign{\smallskip}
1 & 495,513 $\pm$ 20,091 & 493,908 $\pm$ 19,884 \\
2 & 471,206 $\pm$ 24,550 & 469,361 $\pm$ 24,015 \\
3 & 455,42 $\pm$ 28,240 & 452,787 $\pm$ 29,438 \\
4 & 431,926 $\pm$ 31,682 & 428,206 $\pm$ 31,238 \\
5 & 411,24 $\pm$ 25,023 & 408,387 $\pm$ 23,829 \\
\hline
\end{tabular}
\\
\** Average of the best fitness at the end of each execution\\
\*** Average population fitness  at the end of each execution \\

\end{center}
\end{table}

\begin{figure}[htb]
\centering

\subfigure[Experiment 1]{
   \includegraphics[width=13.5pc] {img/exp1_v2.pdf}
   \label{fig:subfig1}
 }
\subfigure[Experiment 2]{
   \includegraphics[width=13.5pc] {img/exp2_v2.pdf}
   \label{fig:subfig2}
 }
\caption{Average fitness of the 30 best individuals of the GA for each configuration.}

\label{fig:graph}
\end{figure}

\begin{figure}[htb]
\centering

\subfigure[Experiment 1]{
   \includegraphics[width=13.5pc] {img/graph1_v2.pdf}
   \label{fig:evo1}
 }
\subfigure[Experiment 2]{
   \includegraphics[width=13.5pc] {img/graph2_v2.pdf}
   \label{fig:evo2}
 }
\caption{Example of the evolution of the best individual of the GA for the five
  profiles for each configuration.}
% ÃÂÃÂ¿QuÃÂÃÂ© hay que ver aquÃÂÃÂ­? Comparar un nÃÂÃÂºmero de perfiles con otro? - JJ2013

\label{fig:boxplots}
\end{figure}

\subsection{Convert results to literary language}

Every agent has a log that stores all the relevant events in its life
in a simple format. Each line of the log indicates the day, the event
in a short readable format and some extra information. Every agent's
log in the MADE Environment is coherent with all others' logs. Many
plots are being created, with a structured format that can be read by
game engines or natural language processors, but, given the simplicity
of the modeled agents, the stories could be seen by the reader as
non-interesting. This log can be used for evaluation. %In the next
%section we propose a method based on EA to let the author of a story
%promote different behaviours in the MADE agents that could be seen as
%literary archetypes (usually associated with human feelings and high
%level cognitive and memory abilities) that can be used to model NPCs
%in video games (or be used in other creative areas). 
% ÃÂ¿AquÃÂ­ podrÃÂ­as hablar, o volver a hablar, de los perfiles, no? - JJ






% -----------------------------------------------------------------------------
% SEC EXPERIMENTALSETUP

%\section{Experimental setup}
%\label{sec:experimentalsetup}




% (JJ2013): Por quÃÂÃÂÃÂÃÂ© has elegido estos experimentos y no otros? - JJ2013
% (RubÃÂÃÂÃÂÃÂ©n): Done
% No del todo... lee abajo - JJ2013

%For this work, two sample groups of archetypes (or scenes)  have been
%chosen: % why only two and why _these_ two? - JJ2013
%The first one is called ``natality control'' and its goal is to model
%a global archetype (population growth) and four individual memory
%based archetypes (\textit{downtrodden}, \textit{helpless},
%\textit{warrior} and \textit{bad warrior}; these are related to their
%attack and defense behaviors).
                                % DefÃÂÃÂ­nelos, hombre o di
                                % algo de ellos, como "identified
                                % by". ÃÂÃÂ¿Se supone que el lector
                                % sabe lo que son? ÃÂÃÂ¿QuÃÂÃÂ© tiene que ver
                                % la natalidad con los guerreros? - JJ2013





% (RubÃÂÃÂÃÂÃÂ©n) TODO: ÃÂÃÂÃÂÃÂ¿Es interesante poner las expresiones regulares?





 %AMOS, LA QUE TU QUIERAS, RUBEN (Fergu)

% (RubÃÂÃÂÃÂÃÂ©n) TODO: ÃÂÃÂÃÂÃÂ¿Es interesante poner las expresiones regulares?
% -----------------------------------------------------------------------------
% SEC RESULTS
%\section{Results and discussion}
%\label{sec:results}









%\clearpage


% -----------------------------------------------------------------------------
% SEC CONCLUSIONS

%Lo mÃÂÃÂ¡s importante: responde a las preguntas que te has planteado? - JJ2013

\section{Conclusions}
\label{sec:conclusion}

%FERGU: REESCRIBIR ENTERA
%This work presents the result obtained by the MADE environment,
                                % no se presenta un entorno,
                                % se presenta los resultados obtenidos
                                % por ÃÂÃÂ©l - JJ2013
                                % (RubÃÂÃÂ©n:) ok
% a self-organized multi-agent
%system to model complex societies which can be used to study
%emergent behaviours for literary purposes; for example, to extract
%interesting plots for NPCs in videogames. %In this paper we have used
%the MADE environment to establish the number of profiles (sets of
%personality parameters) necessary to emerge two different global
%scenes: ``natality control'' and ``revenge'',
%which have been chosen because of their different nature: the first
%one consist in specific archetype rates (related to defense and attack
%behaviours of the agents) inside a global population rate, while the second one
%consist in maximizing the appearance of a memory based archetype, like the
%revenge (as previously said, memory hasn't been explicitly modelled in the
%agent).

This work presents a general methodology to design emergent literary stories in massive virtual worlds. The described steps include the modeling of the agents and literary setting. Then a Genetic Algorithm is used to optimize the parameters of the agent's profiles (behaviors) using
as fitness a function that models the literary setting. %Results show that in the first archetype the number of
%profiles must be at least two, because it is necessary that different
%behaviours (local archetypes) emerge. On the contrary, on the second
%experiment, using only one profile is the best configuration, because
%the purpose was to emerge only one archetype ({\em avenger}). If the
%number of profiles is increased worse results are obtained.

This implies that each scene or combination of desired archetypes for a given
environment can be mapped to a number of profiles that maximize the appearance
of these archetypes, and that the fittest number of profiles and its values can
be obtained by using Genetic Algorithms.  
Given a literary setting, an author of a story or a video game could define 
different rates of archetypes or behavior patterns, and use the techniques described in
the present work to obtain the optimal profiles. The execution of the MADE (Massive Drama Engine for non-player characters) Environment
using these profiles as input would produce a background (or set of characters' lives)
where the archetypes have emerged and have automatically created massive backstories coherent
with the settings of the artwork.

In future works, more complex agents will be used, with different rules to be modeled. For example, we plan to model more human behaviors such as love or envy, to generate interesting plots such as wars, weddings, or family crimes. Different fitness functions will be used, for example, taking into account human opinions to establish the interestingness of a generated plot. Also, this system will be tested into an existent and well-known game, such as Skyrim\texttrademark, whose AI engine is publicly available for players and researchers.

% -----------------------------------------------------------------------------
% SEC ACKNOWLEGGEMENTS


%\section{Acknowledgments}
%This work has been supported in part %by FPU research grant AP2009-2942 and projects AmIVital (CENIT2007-1010), EvOrq (P08-TIC-03903), UGR PR-PP2011-5 and TIN2011-28627-C04-02.

%
% The following two commands are all you need in the
% initial runs of your .tex file to
% produce the bibliography for the citations in your paper.


%\bibliographystyle{abbrv} CAMBIAR!!!!!!
\bibliographystyle{apalike}
\bibliography{made}  % sigproc.bib is the name of the Bibliography in this case


\end{document}
